{{- range .Values.shares }}
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: smb-{{ .name }}
  labels:
    {{- include "smb-storage.labels" $ | nindent 4 }}
    share: {{ .name }}
    server: {{ .server }}
    share-name: {{ .share }}
spec:
  capacity:
    storage: {{ .size }}
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: {{ $.Values.storageClass.name }}
  hostPath:
    path: {{ .path }}
    {{- if eq .share "data" }}
    # Data share - CRITICAL: Must exist, never create to avoid data loss
    # This is shared data that should not be overwritten
    # The directory must already exist on the SMB server
    type: Directory
    {{- else if eq .share "halvor" }}
    # Halvor share - can create directory for new share (container runtime data only)
    type: DirectoryOrCreate
    {{- else }}
    # Backups use subdirectories - can create k8s subdir if needed
    type: DirectoryOrCreate
    {{- end }}
  {{- if $.Values.nodeSelector }}
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        {{- range $key, $value := $.Values.nodeSelector }}
        - key: {{ $key }}
          operator: In
          values:
          - {{ $value | quote }}
        {{- end }}
  {{- end }}
{{- end }}

