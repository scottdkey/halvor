services:
  halvor-web-dev:
    build:
      context: ..
      dockerfile: projects/web/Dockerfile
      target: development
    ports:
      - '13001:13001' # Agent port
      - '13000:13000' # Web server port
    volumes:
      - ../projects/web:/app/halvor-web
      - halvor-data:/app/data # Shared database volume
      - /app/node_modules
    # Environment variables are inherited from direnv (loaded via .envrc)
    environment:
      - RUST_LOG=debug
      - HALVOR_DB_DIR=/app/data
      - HALVOR_WEB_DIR=/app/halvor-web
    restart: always
    healthcheck:
      test: ['CMD', '/app/healthcheck.sh']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    command: >
      sh -c "
        # Verify halvor binary is available
        which halvor || echo 'halvor not in PATH, checking /usr/local/bin...'
        ls -la /usr/local/bin/halvor || echo 'halvor binary not found'
        # Start agent on 13001 and web server on 13000
        # Web UI: http://localhost:13000
        # Agent API (for CLI): port 13001
        /usr/local/bin/halvor agent start --port 13001 --web-port 13000
      "

  halvor-web-prod:
    build:
      context: ..
      dockerfile: projects/web/Dockerfile
      target: production
    ports:
      - '13003:13001' # Agent port (different from dev)
      - '13004:13000' # Web server port
    volumes:
      - halvor-data:/app/data # Shared database volume
    # Environment variables are inherited from direnv (loaded via .envrc)
    environment:
      - RUST_LOG=info
      - HALVOR_DB_DIR=/app/data
      - HALVOR_WEB_DIR=/app/halvor-web
    restart: always
    healthcheck:
      test: ['CMD', '/app/healthcheck.sh']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  halvor-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/../halvor-data # Mount to project root (one level up from halvor-web)
