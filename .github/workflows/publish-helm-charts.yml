name: Publish Helm Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  package-and-publish:
    name: Package and Publish Helm Charts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Package charts
        run: |
          mkdir -p packaged-charts
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            if [ -f "$chart/Chart.yaml" ]; then
              echo "Packaging chart: $chart_name"
              helm package "$chart" -d packaged-charts/
            fi
          done

      - name: Create chart index
        run: |
          helm repo index packaged-charts --url https://github.com/scottdkey/halvor/releases/download/latest

      - name: Upload chart packages
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: packaged-charts/*.tgz
          retention-days: 30

      - name: Upload chart index
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-index
          path: packaged-charts/index.yaml
          retention-days: 30

      - name: Create GitHub Release (if not exists)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: charts-latest
          name: Helm Charts (Latest)
          body: |
            Helm charts packaged from main branch.

            ## Installation

            Add this repository to Helm:
            ```bash
            helm repo add halvor https://scottdkey.github.io/halvor/charts
            helm repo update
            ```

            Or install directly from GitHub releases:
            ```bash
            helm install pia-vpn https://github.com/scottdkey/halvor/releases/download/charts-latest/pia-vpn-0.1.0.tgz
            ```
          files: |
            packaged-charts/*.tgz
            packaged-charts/index.yaml
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to GitHub Pages (for Helm repo)
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packaged-charts
          destination_dir: charts
          keep_files: false
